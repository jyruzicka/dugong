var Dugong={};Dugong.stalkLength=200,Dugong.boxMinHeight=50,Dugong.boxRatio=2,Dugong.canvasMargin=100,Dugong.boxMargin=10,Dugong.e=function(t,n){var e=document.createElementNS("http://www.w3.org/2000/svg",t);if(n)for(var i=Object.keys(n),h=0;h<i.length;h++){var r=i[h];"innerHTML"==r?e[r]=n[r]:e.setAttributeNS(null,r,n[r])}return e},Dugong.Diagram=function(t){this.parentElement=t,this.svg=Dugong.e("svg"),this.svg.setAttributeNS(null,"class","dugong"),this.repulse=function(t){null==t&&(t=1);for(var n=this.nodes,e=0;t>e;e++){var i=this.energy();if(this.eachNode(function(){this.repulse(n)}),i==this.energy())return}},this.energy=function(){var t=0,n=this.nodes;return this.eachNode(function(){t+=this.energy(n)}),t},this.redraw=function(){this.eachNode(function(){this.redraw()})},this.resize=function(){this.eachNode(function(){this.resize()})},this.eachNode=function(t){for(var n=0;n<this.nodes.length;n++)t.bind(this.nodes[n])()},this.zoom=function(){var t={l:0,r:0,t:0,b:0};this.eachNode(function(){var n=this.centre();n.x<t.l&&(t.l=n.x),n.x>t.r&&(t.r=n.x),n.y<t.t&&(t.t=n.y),n.y>t.b&&(t.b=n.y)}),this.svg.setAttributeNS(null,"viewBox",t.l-Dugong.canvasMargin+" "+(t.t-Dugong.canvasMargin)+" "+(t.r-t.l+2*Dugong.canvasMargin)+" "+(t.b-t.t+2*Dugong.canvasMargin))},this.rootNode=null,this.nodes=[];for(var n={},e=t.innerHTML.replace(/(^\s+|\s+$)/g,"").split("\n"),i=/^(\s+)(.*)/,h=0;h<e.length;h++){var r=e[h],s=new Dugong.Node(r);this.nodes.push(s),this.rootNode||(this.rootNode=s);var o=0,g=i.exec(r);g&&(o=g[1].length,s.name=g[2]);for(var a=Object.keys(n),u=null,l=-1,c=0;c<a.length;c++){var d=a[c];d>=o?delete n[d]:d>l&&(l=d,u=n[d])}u&&u.addChild(s),n[o]=s}t.innerHTML="",t.appendChild(this.svg);var f=this;this.eachNode(function(){this.attachSkeleton(f)}),this.eachNode(function(){this.attachBoxes(f)}),this.zoom(),this.redraw()},Dugong.Node=function(t){this.name=t,this.height=Dugong.boxMinHeight,this.width=Dugong.boxMinHeight*Dugong.boxMinHeight*Dugong.boxRatio,this.children=[],this.parent=null,this.g=Dugong.e("g"),this.box=Dugong.e("rect",{rx:12}),this.g.appendChild(this.box),this.text=Dugong.e("foreignObject",{requiredExtentions:"http://www.w3.org/1999/xhtml"}),this.g.appendChild(this.text);var n=document.createElement("div");n.style.display="inline-block",n.style.minWidth="100%",n.innerHTML=this.name,this.text.appendChild(n),this.connector=Dugong.e("line",{stroke:"#000"}),this.generation=function(){return null==this.parent?0:this.parent.generation()+1},this.centre=function(){if(null==this.parent)return new Dugong.Point(0,0);var t=Dugong.Point.fromAngleAndRadius(this.parent.angleTo(this),Dugong.stalkLength);return this.parent.centre().add(t)},this.attachSkeleton=function(t){t.svg.appendChild(this.connector)},this.attachBoxes=function(t){t.svg.appendChild(this.g)},this.resize=function(){for(var t=this.text,n=t.childNodes[0],e=Dugong.boxMinHeight,i=e*Dugong.boxRatio;;){if(t.setAttributeNS(null,"height",e-2*Dugong.boxMargin),t.setAttributeNS(null,"width",i-2*Dugong.boxMargin),!(n.offsetHeight>e-2*Dugong.boxMargin||n.offsetWidth>i-2*Dugong.boxMargin))break;e+=1,i=e*Dugong.boxRatio}this.height=e,this.width=e*Dugong.boxRatio},this.redraw=function(){var t=this.centre(),n=this.width/2,e=this.height/2,i="gen-"+this.generation();if(this.g.setAttributeNS(null,"class",i),this.box.setAttributeNS(null,"x",t.x-n),this.box.setAttributeNS(null,"y",t.y-e),this.box.setAttributeNS(null,"width",this.width),this.box.setAttributeNS(null,"height",this.height),this.text.setAttributeNS(null,"x",t.x-n+Dugong.boxMargin),this.text.setAttributeNS(null,"y",t.y-e+Dugong.boxMargin),this.text.setAttributeNS(null,"width",this.width-2*Dugong.boxMargin),this.text.setAttributeNS(null,"height",this.height-2*Dugong.boxMargin),this.connector.setAttributeNS(null,"x1",t.x),this.connector.setAttributeNS(null,"y1",t.y),this.parent){var h=this.parent.centre();this.connector.setAttributeNS(null,"x2",h.x),this.connector.setAttributeNS(null,"y2",h.y)}else this.connector.setAttributeNS(null,"x2",t.x),this.connector.setAttributeNS(null,"y2",t.y);this.connector.setAttributeNS(null,"class",i)},this.addChild=function(t){t.parent=this,this.children.push({node:t,angle:0}),this.arrangeChildren()},this.angleTo=function(t){for(var n=0;n<this.children.length;n++){var e=this.children[n];if(e.node==t)return e.angle}return null},this.arrangeChildren=function(){var t=this.arc(),n=0;this.parent&&(n=(this.parent.angleTo(this)-t/2)%(2*Math.PI));var e=t/this.children.length;n+=e/2;for(var i=0;i<this.children.length;i++){var h=this.children[i],r=(n+e*i)%(2*Math.PI);h.angle=r,h.node.arrangeChildren()}},this.arc=function(){return this.parent?this.parent.arc()/this.parent.children.length:2*Math.PI},this.nudgeChild=function(t,n){for(var e=0;e<this.children.length;e++){var i=this.children[e];if(i.node==t)return void(i.angle=i.angle+n)}},this.energy=function(t,n){if(null==this.parent)return 0;n&&this.parent.nudgeChild(this,n);for(var e=0,i=this.centre(),h=0;h<t.length;h++)t[h]!=this&&(e+=1/i.squaredDistanceTo(t[h].centre()));return n&&this.parent.nudgeChild(this,-n),e},this.repulse=function(t){if(null!=this.parent){for(var n=this.energy(t),e=0,i=-1;1>=i;i+=.05){var h=this.energy(t,i);n>h&&(n=h,e=i)}0!=e&&this.parent.nudgeChild(this,e)}}},Dugong.Point=function(t,n){this.x=t,this.y=n,this.add=function(t){return new Dugong.Point(this.x+t.x,this.y+t.y)},this.squaredDistanceTo=function(t){return Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2)}},Dugong.Point.fromAngleAndRadius=function(t,n){var e=n*Math.cos(t),i=n*Math.sin(t);return new Dugong.Point(e,i)},Dugong.populate=function(t){window.addEventListener("load",function(){for(var n=document.getElementsByClassName(t),e=0;e<n.length;e++){var i=n[e];if("svg"!=i.tagName){var h=new Dugong.Diagram(i);h.resize(),h.repulse(100),h.redraw(),h.zoom()}}},!1)};
